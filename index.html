<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lombardia - Mappa + Report + Popolazione 2002–2024</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- TopoJSON client -->
  <script src="https://unpkg.com/topojson-client@3/dist/topojson-client.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; background:#fff; }

    .app{
      height:100%;
      display:grid;
      grid-template-rows: 1fr 340px;
    }
    .top{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      min-height: 0;
    }

    /* LEFT */
    .left{
      display:grid;
      grid-template-rows:auto 1fr;
      border-right:1px solid #e8e8e8;
      min-width:320px;
      min-height:0;
      background:#fff;
    }
    .toolbar{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding:10px;
      border-bottom:1px solid #e8e8e8;
      display:grid;
      grid-template-columns: 1fr 1fr auto;
      gap:10px;
      align-items:end;
      background:#fff;
    }
    label{ font-size:12px; opacity:.75; display:block; margin-bottom:4px; }
    select, button, input{
      padding:10px;
      border:1px solid #d8d8d8;
      border-radius:12px;
      background:#fff;
      font-size:14px;
      outline:none;
    }
    select{ width:100%; }
    button{ cursor:pointer; }
    button:active{ transform: translateY(1px); }
    #map{ width:100%; height:100%; }

    /* RIGHT (modern) */
    .right{
      display:grid;
      grid-template-rows:auto 1fr;
      background:#f7f7fb;
      min-height:0;
    }
    .report-head{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding:14px;
      border-bottom:1px solid #e8e8e8;
      background:#fff;
    }
    .report-head h2{
      margin:0 0 6px 0;
      font-size:16px;
      font-weight:800;
    }
    .report-head .sub{
      font-size:13px;
      opacity:.75;
      line-height:1.3;
    }
    .report-controls{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    .report-stats{
      margin-top:8px;
      font-size:12px;
      opacity:.75;
      line-height:1.25;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #ececf3;
      background:#fafafe;
      font-weight:700;
    }
    .pill span{ font-weight:800; }

    .report-body{
      padding:12px 14px 14px 14px;
      overflow:auto;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      min-height:0;
    }

    .empty{
      padding:12px;
      background:#fff;
      border:1px solid #e8e8e8;
      border-radius:16px;
      font-size:14px;
      line-height:1.35;
      box-shadow: 0 6px 18px rgba(0,0,0,.04);
    }

    /* Modern cards */
    .cat-card{
      background:#fff;
      border:1px solid #ececf3;
      border-radius:18px;
      box-shadow: 0 10px 24px rgba(0,0,0,.05);
      margin:12px 0;
      overflow:hidden;
    }
    .cat-head{
      padding:12px 12px 10px 12px;
      display:grid;
      grid-template-columns: 12px 1fr auto;
      gap:10px;
      align-items:center;
      cursor:pointer;
      user-select:none;
    }
    .cat-dot{ width:12px; height:12px; border-radius:999px; background:#999; }
    .cat-title{
      font-weight:900;
      font-size:14px;
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
    }
    .cat-title small{
      font-weight:700;
      opacity:.65;
      font-size:12px;
    }
    .badges{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .badge{
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #ececf3;
      background:#fafafe;
      white-space:nowrap;
    }
    .progress{
      height:8px;
      border-radius:999px;
      background:#f1f1f8;
      margin:0 12px 10px 12px;
      overflow:hidden;
    }
    .progress > div{
      height:100%;
      width:0%;
      border-radius:999px;
      background:#1f2a44;
    }
    .cat-body{
      border-top:1px solid #f0f0f6;
      padding: 6px 12px 12px 12px;
    }
    .ind-row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      padding:10px 0;
      border-bottom:1px solid #f3f3f8;
    }
    .ind-row:last-child{ border-bottom:none; }
    .ind-name{ font-size:13px; font-weight:800; line-height:1.25; }
    .ind-code{ font-size:12px; opacity:.65; margin-top:2px; }
    .ind-method{ font-size:12px; opacity:.75; margin-top:6px; line-height:1.25; }
    .ind-val{
      font-variant-numeric: tabular-nums;
      font-size:14px;
      font-weight:900;
      white-space:nowrap;
      padding-left:10px;
      align-self:start;
    }
    .muted{ opacity:.6; font-weight:700; }

    .cat-footer{
      margin-top:10px;
      display:flex;
      justify-content:center;
    }
    .link-btn{
      border:none;
      background:transparent;
      color:#1f2a44;
      font-weight:900;
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
    }
    .link-btn:hover{ background:#f4f4fb; }

    /* Category colors */
    .c0 { background:#5B8FF9; }
    .c1 { background:#61DDAA; }
    .c2 { background:#65789B; }
    .c3 { background:#F6BD16; }
    .c4 { background:#7262fd; }
    .c5 { background:#78D3F8; }
    .c6 { background:#F6903D; }

    /* Bottom chart */
    .bottom{
      border-top:1px solid #e8e8e8;
      background:#fff;
      padding:12px 14px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      overflow:hidden;
    }
    .bottom-head{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:12px;
      flex-wrap:wrap;
    }
    .bottom-title{ font-weight:900; font-size:14px; }
    .bottom-sub{ font-size:12px; opacity:.75; margin-top:4px; line-height:1.25; }
    .chart-wrap{ height:255px; margin-top:10px; }

    @media (max-width: 980px){
      .top{ grid-template-columns: 1fr; }
      .left{ border-right:none; border-bottom:1px solid #e8e8e8; }
      .app{ grid-template-rows: 1fr 360px; }
      .chart-wrap{ height:270px; }
    }
  </style>
</head>

<body>
<div class="app">
  <div class="top">
    <div class="left">
      <div class="toolbar">
        <div>
          <label for="provSel">Provincia</label>
          <select id="provSel" disabled>
            <option value="">Caricamento…</option>
          </select>
        </div>

        <div>
          <label for="comSel">Comune</label>
          <select id="comSel" disabled>
            <option value="">Seleziona prima una provincia</option>
          </select>
        </div>

        <div>
          <button id="resetBtn" type="button">Reset</button>
        </div>
      </div>

      <div id="map"></div>
    </div>

    <div class="right">
      <div class="report-head">
        <h2 id="reportTitle">Report comunale</h2>
        <div class="sub" id="reportSub">
          Seleziona un comune dalla mappa o dal menu per vedere gli indicatori.
        </div>

        <div class="report-controls">
          <input id="indSearch" type="text" placeholder="Cerca indicatore…" />
          <button id="toggleND" type="button">Mostra n.d.</button>
        </div>

        <div id="reportStats" class="report-stats"></div>
      </div>

      <div class="report-body" id="reportBody">
        <div class="empty">
          Nessun comune selezionato.<br><br>
          Suggerimento: clicca una <b>provincia</b>, poi seleziona un <b>comune</b>.
        </div>
      </div>
    </div>
  </div>

  <div class="bottom">
    <div class="bottom-head">
      <div>
        <div class="bottom-title">Popolazione (2002–2024) — istogramma</div>
        <div id="popSub" class="bottom-sub">Nessun comune selezionato: visualizzo Lombardia.</div>
      </div>
    </div>

    <div class="chart-wrap">
      <canvas id="popChart"></canvas>
    </div>
  </div>
</div>

<script>
  /************************************************************
   * FILE JSON (stessa cartella di index.html)
   ************************************************************/
  const META_URL = "./indicator_meta.json";
  const DATA_URL = "./commune_data.json";
  const POP_URL  = "./population_series.json";

  /************************************************************
   * CONFINI (openpolis/geojson-italy)
   ************************************************************/
  const TOPO_URL =
    "https://raw.githubusercontent.com/openpolis/geojson-italy/master/topojson/limits_IT_all.topo.json";

  const REGION_NAME = "Lombardia";

  const G = {
    regName: "reg_name",
    provName: "prov_name",
    provCode: "prov_istat_code",
    comName: "name",
    comProvCode: "prov_istat_code"
  };

  /************************************************************
   * MAPPA (basemap politica: CARTO Voyager)
   ************************************************************/
  const map = L.map("map", { zoomControl: true, maxBoundsViscosity: 1.0 });

  L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
    { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors &copy; CARTO' }
  ).addTo(map);

  const provSel = document.getElementById("provSel");
  const comSel  = document.getElementById("comSel");
  const resetBtn = document.getElementById("resetBtn");

  let provinces = [];
  let communesTopo = [];
  let provLayer = null;
  let comLayer = null;
  let lombardiaBounds = null;
  let selectedProvCode = null;

  function safe(p, k) { return (p && p[k] != null) ? String(p[k]) : ""; }

  function clearSelect(sel, placeholder) {
    sel.innerHTML = "";
    const o = document.createElement("option");
    o.value = "";
    o.textContent = placeholder;
    sel.appendChild(o);
  }

  function setOptions(sel, items, placeholder) {
    clearSelect(sel, placeholder);
    for (const it of items) {
      const o = document.createElement("option");
      o.value = it.value;
      o.textContent = it.label;
      sel.appendChild(o);
    }
  }

  function fitTo(layer) {
    const b = layer.getBounds();
    if (b && b.isValid()) map.fitBounds(b, { padding: [16, 16] });
  }

  function styleProv(code) {
    const isSel = code && code === selectedProvCode;
    return { color: "#1f2a44", weight: isSel ? 3 : 1.5, fillOpacity: isSel ? 0.20 : 0.12 };
  }

  function styleCom(isSel) {
    return { color: "#2c3e66", weight: isSel ? 2.5 : 1, fillOpacity: isSel ? 0.25 : 0.08 };
  }

  function drawProvinces() {
    if (provLayer) provLayer.remove();
    provLayer = L.geoJSON(
      { type: "FeatureCollection", features: provinces },
      {
        style: (f) => styleProv(safe(f.properties, G.provCode)),
        onEachFeature: (f, layer) => {
          const name = safe(f.properties, G.provName) || "Provincia";
          const code = safe(f.properties, G.provCode);
          layer.bindTooltip(name, { sticky: true });
          layer.on("click", () => { if (code) selectProvince(code); });
        }
      }
    ).addTo(map);
  }

  function drawCommunes(filtered) {
    if (comLayer) comLayer.remove();
    comLayer = L.geoJSON(
      { type: "FeatureCollection", features: filtered },
      {
        style: () => styleCom(false),
        onEachFeature: (f, layer) => {
          const name = safe(f.properties, G.comName) || "Comune";
          layer.bindTooltip(name, { sticky: true });
          layer.on("click", () => {
            const cname = safe(f.properties, G.comName);
            comSel.value = cname;
            highlightComuneOnMap(cname);
            setSelectedComune(cname);
          });
        }
      }
    ).addTo(map);
  }

  function highlightComuneOnMap(name) {
    if (!name || !comLayer) return;
    comLayer.eachLayer(l => {
      const cname = safe(l.feature?.properties, G.comName);
      l.setStyle(styleCom(cname === name));
      if (cname === name) {
        try { map.fitBounds(l.getBounds(), { padding: [16,16], maxZoom: 12 }); } catch {}
      }
    });
  }

  function selectProvince(code) {
    selectedProvCode = code;
    drawProvinces();
    provSel.value = code;

    const filtered = communesTopo.filter(f => safe(f.properties, G.comProvCode) === code);

    const items = filtered
      .map(f => safe(f.properties, G.comName))
      .filter(Boolean)
      .sort((a,b) => a.localeCompare(b, "it"))
      .map(n => ({ value: n, label: n }));

    comSel.disabled = false;
    setOptions(comSel, items, "Seleziona un comune");

    drawCommunes(filtered);

    const provFeat = provinces.find(f => safe(f.properties, G.provCode) === code);
    if (provFeat) {
      const tmp = L.geoJSON(provFeat);
      fitTo(tmp);
      tmp.remove();
    }
  }

  /************************************************************
   * REPORT (modern cards)
   ************************************************************/
  const reportTitle = document.getElementById("reportTitle");
  const reportSub   = document.getElementById("reportSub");
  const reportBody  = document.getElementById("reportBody");
  const indSearch   = document.getElementById("indSearch");
  const toggleND    = document.getElementById("toggleND");
  const reportStats = document.getElementById("reportStats");

  let meta = null;
  let dataRows = null;
  let rowByComune = new Map();

  let showND = false;
  let searchQuery = "";
  let selectedComuneNameForReport = null;

  // quante righe mostrare prima di "mostra dettagli"
  const DEFAULT_VISIBLE_ROWS = 8;

  function normComuneName(s) {
    return String(s || "")
      .trim()
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }

  function setEmptyReport() {
    reportTitle.textContent = "Report comunale";
    reportSub.textContent = "Seleziona un comune dalla mappa o dal menu per vedere gli indicatori.";
    reportBody.innerHTML = `
      <div class="empty">
        Nessun comune selezionato.<br><br>
        Suggerimento: clicca una <b>provincia</b>, poi seleziona un <b>comune</b>.
      </div>
    `;
    reportStats.textContent = "";
  }

  function formatValue(v) {
    if (v === null || v === undefined || v === "") return "<span class='muted'>n.d.</span>";
    if (typeof v === "number") return v.toLocaleString("it-IT", { maximumFractionDigits: 4 });
    return String(v);
  }

  function colorClassForCat(cat) { return "c" + String(cat); }

  function buildIndicatorsByCat() {
    const m = new Map();
    for (const ind of meta.indicators) {
      const c = ind.cat;
      if (!m.has(c)) m.set(c, []);
      m.get(c).push(ind);
    }
    return m;
  }

  function pct(a,b){ return b ? Math.round((a/b)*100) : 0; }

  function renderReportForComune(comuneName) {
    if (!meta || !dataRows) return;

    const key = normComuneName(comuneName);
    const row = rowByComune.get(key);

    reportTitle.textContent = `Report: ${comuneName}`;
    reportSub.textContent = "Categorie ordinate (0→6), ricerca e gestione n.d.";

    if (!row) {
      reportBody.innerHTML = `
        <div class="empty">
          Comune <b>${comuneName}</b> non trovato nella colonna <b>Amm_2</b> della “Banca dati”.<br><br>
          Possibili cause: differenze di scrittura (spazi, apostrofi, accenti).
        </div>
      `;
      reportStats.textContent = "";
      return;
    }

    const byCat = buildIndicatorsByCat();
    const cats = [...meta.categories].sort((a,b) => a.cat - b.cat);

    // conteggi globali (post filtro ricerca ma pre filtro n.d. per trasparenza)
    let totalFiltered = 0;
    let availableFiltered = 0;

    const cardsHtml = cats.map((c, idx) => {
      const catId = c.cat;
      const catName = c.name;
      const dotClass = colorClassForCat(catId);

      // indicatori in categoria
      let items = (byCat.get(catId) || []).slice();

      // ordinamento: per label poi code
      items.sort((a,b) =>
        (a.label || "").localeCompare(b.label || "", "it") ||
        (a.code || "").localeCompare(b.code || "", "it")
      );

      // filtro ricerca
      if (searchQuery) {
        items = items.filter(ind =>
          (ind.label || "").toLowerCase().includes(searchQuery) ||
          (ind.code || "").toLowerCase().includes(searchQuery)
        );
      }

      // conteggi categoria
      const totalInCat = items.length;
      let availableInCat = 0;

      // costruzione righe, con gestione n.d. e "mostra dettagli"
      const rowsAll = [];
      for (const ind of items) {
        const v = row[ind.code];
        const isND = (v === null || v === undefined || v === "");
        if (!isND) availableInCat += 1;

        // se non mostro n.d., salto quelli vuoti
        if (!showND && isND) continue;

        const methodHtml = ind.method ? `<div class="ind-method">${ind.method}</div>` : "";
        rowsAll.push(`
          <div class="ind-row">
            <div>
              <div class="ind-name">${ind.label}</div>
              <div class="ind-code">${ind.code}</div>
              ${methodHtml}
            </div>
            <div class="ind-val">${formatValue(v)}</div>
          </div>
        `);
      }

      totalFiltered += totalInCat;
      availableFiltered += availableInCat;

      // se la card non ha righe da mostrare (con filtri attuali)
      const shownCount = rowsAll.length;

      // progress basato su available/total (totalInCat post ricerca)
      const p = pct(availableInCat, totalInCat);

      // gestione collapse (prima card aperta, le altre chiuse)
      const isOpenDefault = (idx === 0);
      const bodyStyle = isOpenDefault ? "" : "style='display:none;'";

      // mostra solo prime N righe e bottone "Mostra dettagli" se necessario
      const needsMore = shownCount > DEFAULT_VISIBLE_ROWS;
      const rowsInitial = needsMore ? rowsAll.slice(0, DEFAULT_VISIBLE_ROWS).join("") : rowsAll.join("");
      const rowsHidden = needsMore ? rowsAll.slice(DEFAULT_VISIBLE_ROWS).join("") : "";

      const moreBlock = needsMore ? `
        <div class="more-block" style="display:none;">
          ${rowsHidden}
        </div>
        <div class="cat-footer">
          <button class="link-btn" type="button" data-action="toggleMore">Mostra dettagli</button>
        </div>
      ` : "";

      return `
        <div class="cat-card" data-cat="${catId}">
          <div class="cat-head" data-action="toggleCard" aria-expanded="${isOpenDefault ? "true":"false"}">
            <span class="cat-dot ${dotClass}"></span>
            <div class="cat-title">
              ${catId}) ${catName}
              <small>${searchQuery ? "filtrata" : ""}</small>
            </div>
            <div class="badges">
              <span class="badge">${availableInCat}/${totalInCat}</span>
              <span class="badge">${p}%</span>
            </div>
          </div>
          <div class="progress"><div style="width:${p}%;"></div></div>

          <div class="cat-body" ${bodyStyle}>
            ${shownCount ? rowsInitial : "<div class='muted' style='padding:10px 0;'>Nessun indicatore da mostrare con i filtri attuali.</div>"}
            ${moreBlock}
          </div>
        </div>
      `;
    }).join("");

    reportBody.innerHTML = cardsHtml;

    const pAll = pct(availableFiltered, totalFiltered);
    reportStats.innerHTML = `
      <span class="pill">Valorizzati: <span>${availableFiltered}/${totalFiltered}</span> (${pAll}%)</span>
      ${searchQuery ? `<span class="pill">Filtro: <span>${escapeHtml(searchQuery)}</span></span>` : ""}
      <span class="pill">n.d.: <span>${showND ? "visibili" : "nascosti"}</span></span>
    `;

    // attacca listeners alle card
    reportBody.querySelectorAll(".cat-head").forEach(el => {
      el.addEventListener("click", () => {
        const card = el.closest(".cat-card");
        const body = card.querySelector(".cat-body");
        const isOpen = body.style.display !== "none";
        body.style.display = isOpen ? "none" : "block";
        el.setAttribute("aria-expanded", isOpen ? "false" : "true");
      });
    });

    reportBody.querySelectorAll("button[data-action='toggleMore']").forEach(btn => {
      btn.addEventListener("click", () => {
        const card = btn.closest(".cat-card");
        const more = card.querySelector(".more-block");
        const isOpen = more.style.display !== "none";
        more.style.display = isOpen ? "none" : "block";
        btn.textContent = isOpen ? "Mostra dettagli" : "Nascondi dettagli";
      });
    });
  }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  indSearch.addEventListener("input", (e) => {
    searchQuery = (e.target.value || "").trim().toLowerCase();
    if (selectedComuneNameForReport) renderReportForComune(selectedComuneNameForReport);
  });

  toggleND.addEventListener("click", () => {
    showND = !showND;
    toggleND.textContent = showND ? "Nascondi n.d." : "Mostra n.d.";
    if (selectedComuneNameForReport) renderReportForComune(selectedComuneNameForReport);
  });

  function setSelectedComune(cname){
    // report
    selectedComuneNameForReport = cname;
    renderReportForComune(cname);

    // chart
    selectedComuneName = cname;
    renderPopulationChart();
  }

  /************************************************************
   * GRAFICO POPOLAZIONE (1 sola serie alla volta)
   ************************************************************/
  const popSub = document.getElementById("popSub");

  let popRows = null;
  let popByComune = new Map();

  const YEARS = Array.from({length: 23}, (_, i) => 2002 + i);
  let popChart = null;

  // null => Lombardia
  let selectedComuneName = null;

  function getPopSeries(row) {
    return YEARS.map(y => {
      const v = row ? row[`pop_${y}`] : null;
      return (v === "" || v === undefined) ? null : v;
    });
  }

  function fmtIntIt(v) {
    if (v == null || v === "") return "n.d.";
    const n = Number(v);
    if (!Number.isFinite(n)) return String(v);
    return n.toLocaleString("it-IT", { maximumFractionDigits: 0 });
  }

  function renderPopulationChart() {
    if (!popRows) return;

    const lombRow = popByComune.get(normComuneName("LOMBARDIA"));

    let labelName = "Lombardia";
    let data = getPopSeries(lombRow);

    if (selectedComuneName) {
      const row = popByComune.get(normComuneName(selectedComuneName));
      if (row) {
        labelName = selectedComuneName;
        data = getPopSeries(row);
      } else {
        selectedComuneName = null;
        labelName = "Lombardia";
        data = getPopSeries(lombRow);
      }
    }

    popSub.textContent = selectedComuneName
      ? `Comune selezionato: ${selectedComuneName}`
      : `Nessun comune selezionato: visualizzo Lombardia.`;

    const ctx = document.getElementById("popChart").getContext("2d");

    if (popChart) {
      popChart.data.labels = YEARS;
      popChart.data.datasets[0].label = labelName;
      popChart.data.datasets[0].data = data;
      popChart.update();
      return;
    }

    popChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: YEARS,
        datasets: [{
          label: labelName,
          data,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 400 },
        plugins: {
          legend: { display: true },
          tooltip: {
            callbacks: { label: (ctx) => `${ctx.dataset.label}: ${fmtIntIt(ctx.raw)}` }
          }
        },
        scales: {
          x: {
            title: { display: true, text: "Anno" },
            grid: { display: false },
            ticks: {
              autoSkip: false,
              maxRotation: 0,
              minRotation: 0,
              font: { size: 10 }
            }
          },
          y: {
            title: { display: true, text: "Popolazione" },
            beginAtZero: false,
            ticks: { callback: (v) => Number(v).toLocaleString("it-IT") }
          }
        }
      }
    });
  }

  /************************************************************
   * EVENTI UI
   ************************************************************/
  function resetAll() {
    selectedProvCode = null;

    if (comLayer) comLayer.remove();
    comLayer = null;

    comSel.disabled = true;
    clearSelect(comSel, "Seleziona prima una provincia");

    provSel.value = "";
    drawProvinces();

    if (lombardiaBounds) map.fitBounds(lombardiaBounds, { padding: [20, 20] });

    // report reset
    selectedComuneNameForReport = null;
    indSearch.value = "";
    searchQuery = "";
    showND = false;
    toggleND.textContent = "Mostra n.d.";
    setEmptyReport();

    // chart reset
    selectedComuneName = null;
    renderPopulationChart();
  }

  provSel.addEventListener("change", e => {
    const code = e.target.value;
    if (code) selectProvince(code);
    else resetAll();
  });

  comSel.addEventListener("change", e => {
    const cname = e.target.value;
    if (!cname) return;
    highlightComuneOnMap(cname);
    setSelectedComune(cname);
  });

  resetBtn.addEventListener("click", resetAll);

  /************************************************************
   * INIT
   ************************************************************/
  async function loadJSON(url) {
    const res = await fetch(url, { mode: "cors" });
    if (!res.ok) throw new Error(`Errore download ${url}: ${res.status}`);
    return await res.json();
  }

  (async function init() {
    try {
      meta = await loadJSON(META_URL);
      dataRows = await loadJSON(DATA_URL);
      popRows = await loadJSON(POP_URL);

      rowByComune = new Map();
      for (const r of dataRows) {
        const n = normComuneName(r.Amm_2);
        if (n) rowByComune.set(n, r);
      }

      popByComune = new Map();
      for (const r of popRows) {
        const n = normComuneName(r.Amm_2);
        if (n) popByComune.set(n, r);
      }

      selectedComuneName = null;
      renderPopulationChart();
      setEmptyReport();

      const topo = await loadJSON(TOPO_URL);

      const keys = Object.keys(topo.objects || {});
      const provKey = keys.find(k => k.toLowerCase().includes("prov"));
      const comKey  = keys.find(k => k.toLowerCase().includes("munic") || k.toLowerCase().includes("com"));
      if (!provKey || !comKey) throw new Error("Non riesco a riconoscere i layer province/comuni nel TopoJSON.");

      const provGeo = topojson.feature(topo, topo.objects[provKey]);
      const comGeo  = topojson.feature(topo, topo.objects[comKey]);

      provinces = (provGeo.features || []).filter(f => safe(f.properties, G.regName) === REGION_NAME);
      communesTopo = (comGeo.features || []).filter(f => safe(f.properties, G.regName) === REGION_NAME);

      if (!provinces.length) throw new Error("Filtro Lombardia: nessuna provincia trovata.");

      const lombLayer = L.geoJSON({ type: "FeatureCollection", features: provinces });
      lombardiaBounds = lombLayer.getBounds();

      map.fitBounds(lombardiaBounds, { padding: [20, 20] });
      map.setMaxBounds(lombardiaBounds);
      map.setMinZoom(map.getZoom());
      map.setMaxZoom(13);

      const provItems = provinces
        .map(f => ({
          value: safe(f.properties, G.provCode),
          label: safe(f.properties, G.provName) || safe(f.properties, G.provCode)
        }))
        .filter(x => x.value)
        .sort((a,b) => a.label.localeCompare(b.label, "it"));

      provSel.disabled = false;
      setOptions(provSel, provItems, "Seleziona una provincia");

      drawProvinces();

    } catch (err) {
      console.error(err);
      alert("Errore inizializzazione: " + err.message);

      provSel.disabled = true;
      clearSelect(provSel, "Errore caricamento");
      setEmptyReport();
    }
  })();
</script>
</body>
</html>